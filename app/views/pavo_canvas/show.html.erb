<head>
  <%= javascript_include_tag "jquery-1.10.2.min.js" %>
  <%= javascript_include_tag "jquery-ui-1.10.3.custom.js" %>
</head>

<body>
  <%= javascript_tag "var item_list = #{@item_list.to_json};" %>
  <%= javascript_tag "var canvas = #{@canvas.to_json};" %>
  <%= javascript_tag "var t = '#{@t}';" %>
  <%= javascript_tag "var is_my_canvas = #{@is_my_canvas};" %>

  <script type="text/javascript">
  function getItem(itemId)
  {
    for(var i in item_list.items)
    {
      var item = item_list.items[i];
      if(item.id == itemId)
      {
        return item;
      }
    }
  }

  $(document).ready(function() {
    $("img.item_image").click(function(){
      var itemID = $(this).attr("id");
      var item = getItem(itemID);

      $("div.swan_textbar a").attr("href", item.url);
      $("div.swan_textbar a").text(item.title);
      $("img.item_image").css("border-width", "1px");
      $(this).css("border-width", "3px");
    });
  });

  function draggable_clicked()
  {
    var item = getItem(this.id);
    $("div.swan_textbar a").attr("href", item.url);
    $("div.swan_textbar a").text(item.title);
  }

  $(function ( event, ui )
  {
    $( ".draggable" ).draggable(
    {
      helper: 'clone',
      revert: 'invalid',
    });

    $( ".canvas_item" ).droppable({
      drop: function( event, ui ) {
        var matchedItem = getItem(ui.draggable.attr('id'));
        setItem(matchedItem, $(this));
      }
    });
  });

  function setItem(item, canvasItem)
  {
    var imgUrl = "url(" + item.images[0] + ")";
    var imageItem = $('<div id="image_item"></div>').css({
      'background-image': imgUrl,
      'background-position':'center',
      'background-repeat':'no-repeat',
      'display': 'block',
      'height': canvasItem.height(),
      'width': canvasItem.width(),
      'background-size': 'auto 300px',
      'top' : canvasItem.scrollLeft(),
      'left' : canvasItem.scrollTop(),
      'z-index':9999,
    });
    canvasItem.append(imageItem);
  }
  </script>
  <div class="swan_topbar">
    <div class="image_list">
      <% @item_list.items.reverse_each do |item| %>
      <div class="draggable" id=<%= item.id %>>
        <%= image_tag item.images[0], :class => "item_image", :id => item.id %>
        <!--%= image_tag "change_picture_btn.png" , :class => "change_picture_button" %-->
      </div >
      <% end %>
    </div>
    <div class="swan_textbar"><a target="_blank"></a></div>
  </div>

  <div id="content">
    <div id="canvas"></div>
    <div id="template_selector"></div>
  </div>
  <div style="margin-left: 90%">
    <strong>Owner: <%= @canvas.owner %></strong>
  </div>

  <script type="text/javascript">

  function createReviewButton(review, item)
  {
   var buttonDiv = $('<div class="'+ review +'_div"></div>');
   buttonDiv.click(function(){
    return function(){
      var url = '/pavo_canvas/' + canvas.owner;
      var postData = {
        "review": review,
        "token" : t,
        "target_item": item.id
      };

      $.ajax({
        type: "PUT",
        contentType: "application/json; charset=utf-8",
        url: url,
        data: JSON.stringify(postData),
        dataType: "json",
      }).done(function( data ) {
        alert(review + " success!!");
      });
    }
  }());

   var buttonText = $('<div class="text_div">'+ item[review].length +'</div>');
   buttonText.appendTo(buttonDiv);

   return buttonDiv;
 }

 function setTemplate(template)
 {
  var canvasDiv = $("#canvas");
  canvasDiv.empty();
  var items = template.items;

  for(var i in items)
  {
   var canvasItem = $('<div class="canvas_item"></div>');
   var templateItem = items[i];
   canvasItem.css("left", templateItem[0] + "px");
   canvasItem.css("top", templateItem[1] + "px");
   canvasItem.css("width", templateItem[2] + "px");
   canvasItem.css("height", templateItem[3] + "px");
   canvasItem.appendTo(canvasDiv);

   var obj = canvas.objects[i];
   if(obj == null)
   {
    continue;
  }
  var coverItemId = obj.cover_item;
  var coverItem = obj.canditates[coverItemId];
  setItem(coverItem, canvasItem)

  var buttonContainer = $('<div class="button_container"></div>');
  buttonContainer.appendTo(canvasItem);

  buttonContainer.append(createReviewButton("like", coverItem));
  buttonContainer.append(createReviewButton("suck", coverItem));
}
}

var currentTemplate = getTemplate(canvas.template_id)
setTemplate(currentTemplate);

var templateSelector = $("#template_selector");
for(var index in templates)
{
  var template = templates[index];
  var templateItem = $('<img class="template_item">');
  templateItem.attr('src', template.image);
  templateItem.click(function() {
    var t = template
    return function(){
      setTemplate(t)
    }
  }());
  templateItem.appendTo(templateSelector);
}

</script>

</body>