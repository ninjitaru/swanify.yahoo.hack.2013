<head>
  <%= javascript_include_tag "jquery-1.10.2.min.js" %>
  <%= javascript_include_tag "jquery-ui-1.10.3.custom.js" %>
</head>

<body>
  <script type="text/javascript">
  function searchImageItemById (draggableItemId) {
    for (var i = 0; i < item_list.items.length; i++) {
      var id = item_list.items[i].id;
      if (id == draggableItemId) {
        return item_list.items[i];
      }
    }
    return -1;
  };

  $(function ( event, ui ) {
    $( ".draggable" ).draggable({
      helper: 'clone',
      revert: 'invalid',
    });

    $( ".canvas_item" ).droppable({
        drop: function( event, ui ) {
          var matchedItem = searchImageItemById(ui.draggable.attr('id'));
          var imgUrl = "url(" + matchedItem.images[0] + ")";
          
          var _canvasItem = $(this);
          var imageItem = $('<div id="image_item"></div>').css({
            'background-image': imgUrl,
            'background-position':'center',
            'background-repeat':'no-repeat',
            'display': 'block',
            'height': _canvasItem.height(),
            'width': _canvasItem.width(),
            'background-size': 'auto 300px',
            'top' : _canvasItem.scrollLeft(),
            'left' : _canvasItem.scrollTop(),
            'z-index':9999,
          });
          $(this).append(imageItem);
        }
    }); 
  });
  </script>
  <%= javascript_tag "var item_list = #{@item_list.to_json};" %>

  <p>
    <div class="image_list">
      <% @item_list.items.each do |item| %>
      <div class="draggable" id=<%= item.id %>>
        <a href="#"><%= image_tag item.images[0], :class => "item_image" %></a>
        <%= image_tag "change_picture_btn.png" , :class => "change_picture_button" %>
      </div>
      <% end %>
    </div>
    <div id="content">
      <div id="canvas"></div>
      <div id="template_selector"></div>
    </div>
    <div style="margin-left: 90%">
      <strong>Owner: <%= @canvas.owner %></strong>
    </div>

    <script type="text/javascript">
    function setTemplate(template)
    {
      var canvas = $("#canvas");
      canvas.empty();
      var items = template.items;

      for(var index in items)
      {
       var canvasItem = $('<div class="canvas_item"></div>');
       var item = items[index];
       canvasItem.css("left", item[0] + "px");
       canvasItem.css("top", item[1] + "px");
       canvasItem.css("width", item[2] + "px");
       canvasItem.css("height", item[3] + "px");
       canvas.append(canvasItem);
     }
   }

   var currentTemplate = templates[0];
   setTemplate(currentTemplate);

   var templateSelector = $("#template_selector");
   for(var index in templates)
   {
    var template = templates[index];
    var templateItem = $('<img class="template_item">');
    templateItem.attr('src', template.image);
    templateItem.click(function() {
      var t = template
      return function(){
        setTemplate(t)
      }
    }());
    templateItem.appendTo(templateSelector);
  }


  </script>
</p>
</body>